<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Manager</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h2>Person Transaction Manager</h2>

    <!-- Section for input fields and buttons -->
    <div>
        <label for="persons">Number of Persons:</label>
        <input type="number" id="persons" value="3" oninput="addInputs()">
        <button onclick="addInputs()">Add Inputs</button>
        <button onclick="updateOwesLabels()">Update Owes Labels</button>
        <button onclick="calculateResult()">Calculate Transactions</button>
    </div>

    <!-- Dynamic Input Fields for Names and Payments -->
    <div id="nameInputs"></div>
    <div id="paymentInputs"></div>

    <!-- Canvas for drawing the transaction relationships -->
    <canvas id="transactionCanvas" width="500" height="500"></canvas>

    <!-- Section to show output -->
    <h3>Simplified Transactions:</h3>
    <div id="simplifiedTransactions"></div>
    <pre id="output"></pre>

    <!-- Script Section -->
    <script>
        // MinHeap class for managing debts and payments
        class MinHeap {
            constructor() {
                this.heap = [];
            }

            insert(value) {
                this.heap.push(value);
                this.bubbleUp();
            }

            bubbleUp() {
                let index = this.heap.length - 1;
                while (index > 0) {
                    let parentIndex = Math.floor((index - 1) / 2);
                    if (this.heap[index].amount >= this.heap[parentIndex].amount) break;
                    [this.heap[index], this.heap[parentIndex]] = [this.heap[parentIndex], this.heap[index]];
                    index = parentIndex;
                }
            }

            extractMin() {
                if (this.heap.length === 0) return null;
                if (this.heap.length === 1) return this.heap.pop();

                const min = this.heap[0];
                this.heap[0] = this.heap.pop();
                this.bubbleDown();
                return min;
            }

            bubbleDown() {
                let index = 0;
                const length = this.heap.length;

                while (true) {
                    let leftChildIndex = 2 * index + 1;
                    let rightChildIndex = 2 * index + 2;
                    let smallestIndex = index;

                    if (leftChildIndex < length && this.heap[leftChildIndex].amount < this.heap[smallestIndex].amount) {
                        smallestIndex = leftChildIndex;
                    }
                    if (rightChildIndex < length && this.heap[rightChildIndex].amount < this.heap[smallestIndex].amount) {
                        smallestIndex = rightChildIndex;
                    }
                    if (smallestIndex === index) break;
                    [this.heap[index], this.heap[smallestIndex]] = [this.heap[smallestIndex], this.heap[index]];
                    index = smallestIndex;
                }
            }

            isEmpty() {
                return this.heap.length === 0;
            }
        }

        // Function to dynamically add input fields based on the number of persons
        function addInputs() {
            const numPersons = parseInt(document.getElementById("persons").value);
            const nameInputsDiv = document.getElementById("nameInputs");
            const paymentInputsDiv = document.getElementById("paymentInputs");
            nameInputsDiv.innerHTML = '';
            paymentInputsDiv.innerHTML = '';

            for (let i = 1; i <= numPersons; i++) {
                // Name Input
                nameInputsDiv.innerHTML += `<label for="name${i}">Person ${i} Name:</label>
                <input type="text" id="name${i}" placeholder="Enter Name ${i}"><br>`;
                
                // Payment Inputs
                for (let j = 1; j <= numPersons; j++) {
                    if (i !== j) {
                        paymentInputsDiv.innerHTML += `<label id="label_p${i}p${j}" for="p${i}p${j}">${i} owes ${j}:</label>
                        <input type="number" id="p${i}p${j}" value="0"><br>`;
                    }
                }
                paymentInputsDiv.innerHTML += '<br>';
            }
        }

        // Function to update labels like "1 owes 2" to names like "Alice owes Bob"
        function updateOwesLabels() {
            const numPersons = parseInt(document.getElementById("persons").value);
            const names = [];

            // Collect the names entered by the user
            for (let i = 1; i <= numPersons; i++) {
                const name = document.getElementById(`name${i}`).value.trim() || `Person ${i}`;
                names.push(name);
            }

            // Update the labels with the names
            for (let i = 1; i <= numPersons; i++) {
                for (let j = 1; j <= numPersons; j++) {
                    if (i !== j) {
                        const label = document.getElementById(`label_p${i}p${j}`);
                        if (label) {
                            label.textContent = `${names[i - 1]} owes ${names[j - 1]}:`;
                        }
                    }
                }
            }
        }

        // Function to draw the transaction diagram on canvas
        function drawShapeWithTransactions(numPersons, names, transactions) {
            const canvas = document.getElementById("transactionCanvas");
            const ctx = canvas.getContext("2d");
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 150;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const angleStep = (2 * Math.PI) / numPersons;
            const positions = [];

            for (let i = 0; i < numPersons; i++) {
                const angle = i * angleStep;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                positions.push({ x, y });

                ctx.beginPath();
                ctx.arc(x, y, 30, 0, 2 * Math.PI);
                ctx.fillStyle = "red";
                ctx.fill();
                ctx.stroke();

                ctx.fillStyle = "blue";
                ctx.font = "16px Arial";
                ctx.textAlign = "center";
                ctx.fillText(names[i], x, y - 40);
            }

            transactions.forEach(transaction => {
                const { debtorIndex, creditorIndex, amount } = transaction;
                const debtorPos = positions[debtorIndex];
                const creditorPos = positions[creditorIndex];

                ctx.beginPath();
                ctx.moveTo(debtorPos.x, debtorPos.y);
                ctx.lineTo(creditorPos.x, creditorPos.y);
                ctx.strokeStyle = "gray";
                ctx.lineWidth = 3;
                ctx.stroke();

                const arrowAngle = Math.atan2(creditorPos.y - debtorPos.y, creditorPos.x - debtorPos.x);
                const arrowLength = 15;
                const arrowWidth = 5;

                ctx.beginPath();
                ctx.moveTo(creditorPos.x, creditorPos.y);
                ctx.lineTo(creditorPos.x - arrowLength * Math.cos(arrowAngle - Math.PI / 6),
                           creditorPos.y - arrowLength * Math.sin(arrowAngle - Math.PI / 6));
                ctx.lineTo(creditorPos.x - arrowLength * Math.cos(arrowAngle + Math.PI / 6),
                           creditorPos.y - arrowLength * Math.sin(arrowAngle + Math.PI / 6));
                ctx.lineTo(creditorPos.x, creditorPos.y);
                ctx.fillStyle = "gray";
                ctx.fill();

                const midX = (debtorPos.x + creditorPos.x) / 2;
                const midY = (debtorPos.y + creditorPos.y) / 2;

                ctx.fillStyle = "blue";
                ctx.font = "14px Arial";
                ctx.textAlign = "center";
                ctx.fillText(amount, midX, midY);
            });
        }

        // Function to calculate the result and simplify transactions
        function calculateResult() {
            const numPersons = parseInt(document.getElementById("persons").value);
            const names = [];
            const balance = new Array(numPersons).fill(0);
            let resultText = '';

            // Collect names from the input fields
            for (let i = 1; i <= numPersons; i++) {
                const name = document.getElementById(`name${i}`).value.trim() || `Person ${i}`;
                names.push(name);
            }

            // Calculate balances based on transactions
            for (let i = 1; i <= numPersons; i++) {
                for (let j = 1; j <= numPersons; j++) {
                    if (i !== j) {
                        const amount = parseInt(document.getElementById(`p${i}p${j}`).value) || 0;
                        balance[i - 1] -= amount;
                        balance[j - 1] += amount;
                    }
                }
            }

            resultText += "Person Transactions:\n";
            for (let i = 1; i <= numPersons; i++) {
                for (let j = 1; j <= numPersons; j++) {
                    if (i !== j) {
                        const amount = parseInt(document.getElementById(`p${i}p${j}`).value) || 0;
                        if (amount > 0) {
                            resultText += `${names[i - 1]} owes ${amount} to ${names[j - 1]}\n`;
                        }
                    }
                }
            }

            resultText += "\n--- Intermediate Balances ---\n";
            balance.forEach((bal, index) => {
                resultText += `${names[index]}'s balance: ${bal}\n`;
            });

            document.getElementById("simplifiedTransactions").innerText = '';

            const positiveHeap = new MinHeap();
            const negativeHeap = new MinHeap();

            // Populate heaps with positive and negative balances
            balance.forEach((bal, index) => {
                if (bal > 0) {
                    positiveHeap.insert({ name: names[index], amount: bal });
                } else if (bal < 0) {
                    negativeHeap.insert({ name: names[index], amount: -bal });
                }
            });

            const transactions = [];
            const finalPayments = [];

            // Simplify transactions
            while (!positiveHeap.isEmpty() && !negativeHeap.isEmpty()) {
                const creditor = positiveHeap.extractMin();
                const debtor = negativeHeap.extractMin();

                const paymentAmount = Math.min(creditor.amount, debtor.amount);
                finalPayments.push(`${debtor.name} pays ${paymentAmount} to ${creditor.name}`);

                const debtorIndex = names.indexOf(debtor.name);
                const creditorIndex = names.indexOf(creditor.name);
                transactions.push({ debtorIndex, creditorIndex, amount: paymentAmount });

                creditor.amount -= paymentAmount;
                debtor.amount -= paymentAmount;

                if (creditor.amount > 0) {
                    positiveHeap.insert(creditor);
                }
                if (debtor.amount > 0) {
                    negativeHeap.insert(debtor);
                }
            }

            document.getElementById("output").innerText = finalPayments.join('\n');
            drawShapeWithTransactions(numPersons, names, transactions);
        }
    </script>
</body>
</html>
